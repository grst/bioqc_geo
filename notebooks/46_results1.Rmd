```{r, include=FALSE, message=FALSE}
library(MASS)
library(BioQC)
library(stringr)
library(gridExtra)
library(dplyr)
library(readr)
library(cowplot)
library(readxl)
library(tidyr)
library(foreach)
library(doMC)
registerDoMC(cores=8)
source("config.R")
```

```{r, include=FALSE, cache=TRUE}
load('../results/data_processed.RData')
load('../results/models.RData')

data_corr_array = data_corr 
total_array = data_corr$GSM %>% unique() %>% length()

load('../results/archs4/archs4_data_processed.RData')
load('../results/archs4/archs4_models.RData')

data_corr_ngs = data_corr 
total_ngs = data_corr$GSM %>% unique() %>% length()

datasets = list(
  "GEO"=data_corr_array,
  "ARCHS4"=data_corr_ngs
)
```

## Heterogeneity using GTEX signatures only
```{r heterogeneitygtex, cache=TRUE, include=FALSE}
contam_count = foreach(dataset_name = names(datasets),
        dataset = datasets,
        .combine=bind_rows) %do% {
          contam_count = dataset %>%
            filter(q_corr < TAU, qvalue < TAU) %>% 
            group_by(TGROUP, SIGNATURE) %>%
            summarise(cnt = n_distinct(GSM)) %>%
            mutate(dataset=dataset_name)
        }
```

```{r heterogeneitygtex_fig, echo=FALSE, fig.cap="Tissue heterogeneity assessed with the reference signatures. The annotated tissues are listed in rows, the significantly enriched signatures in columns. If a signature has been found to be significantly enriched in a sample, the sample will count towards the number indicated in the matrix. All contaminations per sample are included, *i.e.* a sample can appear multiple times in a row. ", fig.height=4, fig.width=8}
contam_count %>%
  filter(SIGNATURE %in% reference_signatures$REF_SIG) %>%
  ggplot(aes(x=factor(SIGNATURE, levels=reference_signatures$REF_SIG), y=TGROUP)) +
      geom_tile(aes(fill = cnt)) +
      geom_text(aes(label=cnt)) +
      theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust=.5)) +
      scale_x_discrete(drop=FALSE) +
      facet_wrap(~dataset) + 
      ylab("reference tissue") +
      xlab("detected signature") + 
      scale_fill_distiller(palette = "Blues", direction=1) + 
      background_grid()
```

## Heterogeneity using all signatures
```{r heterogeneityall, fig.width=8, fig.height=24, echo=FALSE, fig.cap="Tissue heterogeneity assessed with the BioQC signatures. The annotated tissues are listed in rows, the significantly enriched signatures in columns. If a signature has been found to be significantly enriched in a sample, the sample will count towards the number indicated in the matrix. All contaminations per sample are included, *i.e.* a sample can appear multiple times in a row."}
bioqc_signatures = selected_signatures %>% filter(str_detect(SIGNATURE, 'BIOQC')) %>% pull("SIGNATURE")
chunks = cut_interval(1:length(bioqc_signatures), length=25, labels=FALSE)

foreach(dataset_name = names(datasets)) %do% {
          plots = lapply(unique(chunks), function(i) {
            tmp_signatures = bioqc_signatures[chunks==i]
            p = contam_count %>%
              filter(dataset == dataset_name) %>% 
              filter(SIGNATURE %in% tmp_signatures) %>%
              ggplot(aes(x=factor(SIGNATURE, levels=tmp_signatures), y=TGROUP)) +
              geom_tile(aes(fill = cnt)) +
              geom_text(aes(label=cnt), size=3) +
              theme_bw() + 
              theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
              scale_x_discrete(drop=FALSE) +
              ylab("reference tissue") +
              xlab("detected signature") +
              theme(axis.text.x = element_text(angle = 45, hjust = 1, size=10)) +
              background_grid(major = "xy", minor="xy") + 
              scale_fill_distiller(palette = "Blues", direction=1, guide = FALSE)
            if(i ==  1) {
              p = p + ggtitle(dataset_name)
            }
            p
          })
          plot_grid(plotlist = plots, ncol=1, nrow = length(plots), align = "h")
        }
```

