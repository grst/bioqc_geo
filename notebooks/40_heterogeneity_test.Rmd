```{r, include=FALSE, message=FALSE}
library(MASS)
library(BioQC)
library(stringr)
library(gridExtra)
library(dplyr)
library(readr)
library(cowplot)
library(readxl)
source("../scripts/config.R")
```

```{r load_data, message=FALSE, include=FALSE, cache=TRUE}
load('../results/data_processed.RData')
load('../results/models.RData')
```
# Testing for tissue heterogeneity
## Tissue signatures {#sec:signatures}
In section \@ref(validating-signatures), we identified a set of
9 *reference signatures* (table \@ref(tab:refsig)) which unambiguously
identify their corresponding tissue across platforms and species.

```{r refsig, cache=TRUE, echo=FALSE}
load('../results/data_processed.RData')
tmp_ref_sig = reference_signatures
colnames(tmp_ref_sig) = c("Reference Signature", "Tissue")
knitr::kable(tmp_ref_sig, caption="reference signatures")
```

## Data {#sec:data_selection}

In section \@ref(sample-selection) we show in detail, how we obtain
and filter data from the Gene Expression Omnibus.
Table \@ref(tab:filteringprocess) shows a summary of this process, listing
the remaining samples and studies after each filtering step.

```{r filteringprocess, echo=FALSE}
filtering = read_excel("../tables/data_filtering.xls")
knitr::kable(filtering, caption="Selecting samples from GEO")
```

## Testing samples for heterogeneity
We tested for enrichment of
`r sum(str_detect(selected_signatures$SIGNATURE, "BIOQC"))`
selected signatures provided by BioQC, the
`r sum(str_detect(selected_signatures$SIGNATURE, "GTEX"))`
reference signatures generated by us and one random control signature of
100 randomly drawn genes on all `r nrow(bioqc_meta)` selected samples
resulting in a list of `r nrow(data2)` (sample, signature, pvalue) pairs.
This process is described in detail in section \@ref(sample-processing).

Our intention is to identify samples that show *tissue heterogeneity*,
*i.e.* unintentional profiling of cells of other origin than the target tissue
of profiling. We classify samples as *not heterogenous* or *heterogenous*.
We call a classification *true-positive* if the given sample is classified
as *heterogenous* and the sample indeed contains cells different from the
annotated tissues. Analogous, we call a classification *false-positive*
if the given sample is classified as *heterogenous* but in reality only contains cells from the annotated tissue.

Naively, we would label a sample as heterogenous, if a signature unrelated
to the annotated tissue exceeds a certain score. The problem with this
approach is, that some signatures overlap; the resulting scores are therefore
correlated and will lead to false-positives. One cannot simply solve this
problem by excuding genes that are members of multiple signatures, as it is
easily possible to build two (in fact many) distinct, non-overlapping
signatures matching the same tissue.

In section \@ref(validating-signatures) we haven created toroughly validated
*reference signatures* for 9 tissues. Even though we have demonstrated that
each signature unambigously identifies its corresponding tissue (*i.e.* scores
highest), the signatures could still be correlated. Some of them in fact are,
e.g. cardiac muscle and skeletal muscle (see figure
\@ref(fig:correlationexample)). Moreover, we lack sufficient data to perform an
independent-sample validation on the signatures provided by BioQC. Accounting
for correlation with the reference signatures, we can still avoid
false-positives, even if a signature is characteristic for a tissue
histologically close to the annotated tissue.

We therefore take the following approach to account for the correlation of signatures:
A given sample $s$ annotated as tissue $t$ is tested for enrichment with signature $k_{\text{test}}$ resulting in a p-value $p_{\text{test}}$. Let $k_{\text{ref}}$ be the reference signature associated with tissue $t$ and $p_{\text{ref}}$ the p-value of testing $s$ for enrichment of $k_{\text{ref}}$.

(1) If the Benjamini-Hochberg-adjusted $p_{\text{test}} >= `r FDR_THRES`$, we
assume that $s$ is not heterogenous; else continue.
(2) We fit a linear model using `rlm` from the `R` `MASS` package of
$|log10(p_{\text{test}})|$ against $|log10(p_{\text{ref}})|$ for all samples
annotated as $t$. We assume that the residuals $R$ of the linear model follow
a normal distribution $R \sim \mathcal{N}(0, \sigma^2)$, where $\sigma$ is the
standard deviation of the residuals.
(3) We extract the residual $r$ corresponding to sample $s$. We calculate the
p-value $p_{\text{corr}} = 1 - \text{CDF}_R(r)$ where $\text{CDF}_R$ is the
cumulative density function of $\mathcal{N}(0, \sigma^2)$.
(4) If the Bonferroni-adjusted $p_{\text{corr}} < `r P_THRES`$, we reject the
hypothesis that $k_{\text{test}}$ is enriched only due to correlation and label
the sample as heterogenous.

```{r correlationexample, fig.width=12, fig.height=9, echo=FALSE, cache=TRUE, fig.cap="Examples of signature correlation. Panels A-C: correlation of the signature scores (y-axis) against the scores of a reference signature (x-axis). The purple line indicates the model fitted to the data, the shaded area the 3*sigma confidence interval. Points are colored according to whether they would be discarded already in the FDR-filtering step. (A) Brain scores of kidney samples against the scores of the kidney signature. There is virtually no correlation, nor are there outliers. Appraently, no kidney samples are contaminated with neuronal cells. (B) Liver scores of kidney samples against scores of the kidney signature. The samples are not correlated, however some outliers are detected which are samples potentially containing liver cells. (C) Cardiac muscle scores of skeletal muscle samples against skeletal muscle scores. The scores are highly correlated. While most of the poinst exceed the FDR threshold, they will not be classified as outliers because the elevated score can be explained with the correlation. Panels D and E show the boxplots of the scores of various signatures on kidney and heart samples respectively. "}
# pairs of signatures we investigate.
pairs = list(c('GTEX_Brain', 'GTEX_Kidney'),
             c('GTEX_Liver', 'GTEX_Kidney'),
             c('GTEX_Muscle_Skeletal', 'GTEX_Heart'))

#' Add a qqline to a stat_qq ggplot2 object.
#'
#' @param vec the values on which stat_qq is calculated.
geom_qqline = function(vec, ...) {
  # following four lines from base R's qqline()
  y <- quantile(vec[!is.na(vec)], c(0.25, 0.75))
  x <- qnorm(c(0.25, 0.75))
  slope <- diff(y)/diff(x)
  int <- y[1L] - slope * x[1L]
  return(geom_abline(slope = slope, intercept = int, ...))
}

# make all plots
plots = lapply(pairs, function(pair) {
  sig = pair[1]
  ref = pair[2]
  plots = list()
  tmp_data = data2 %>%
      filter(SIGNATURE == sig, REF_SIG == ref) %>%
      mutate("fdr_cutoff" = ifelse(qvalue < FDR_THRES, paste("< ", FDR_THRES), paste(">= ", FDR_THRES)))
  tmp_model = rlm(tmp_data$score~tmp_data$ref_score)
  tmp_resid = resid(tmp_model)
  tmp_sigma = sigma(tmp_model)
  tmp_coef = coef(tmp_model)

  #' confidence interval for a given x position.
  ci = function(x, sigma) {
    tmp_coef[1] + x * tmp_coef[2] + sigma
  }

  # correlation plot with fitted linear model
  plots[['corr']] = ggplot(tmp_data, aes(x = ref_score, y = score)) +
        geom_point(aes(colour=fdr_cutoff)) +
        geom_abline(aes(colour="rlm fit", intercept = tmp_coef[1], slope = tmp_coef[2]), show.legend = TRUE) +
        geom_ribbon(aes(colour="3*sigma", ymax=ci(ref_score, 3*tmp_sigma), ymin=ci(ref_score, -3*tmp_sigma)), alpha=.2, show.legend = TRUE) +
        xlab(paste(ref)) +
        ylab(paste(sig)) +
        coord_cartesian(ylim = c(0, 30)) +
        annotate("text", label=paste("slope = ", round(tmp_coef[2], 5)), x=15, y=30)

  # # residue qq plot (only use 10%-90% quantile due to outliers)
  # tmp_resid_quantile = tmp_resid[tmp_resid > quantile(tmp_resid, .1) & tmp_resid < quantile(tmp_resid, .9)]
  # plots[['residue_qq']] = ggplot(data.frame(residues=tmp_resid_quantile), aes(sample=residues)) +
  #   stat_qq() +
  #   geom_qqline(tmp_resid_quantile, col='red') +
  #   ggtitle(paste(sig, ref, sep = "/"))

  # boxplots of the reference signature.
  plots[['boxplots']] = data2 %>%
    filter(REF_SIG == ref, str_detect(SIGNATURE, 'GTEX')) %>%
    ggplot(aes(x = SIGNATURE, y = score)) +
      geom_boxplot() +
      theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
      ggtitle(ref) +
      xlab("signature")

  return(plots)
})


legend_corr = get_legend(plots[[3]][["corr"]] + theme(legend.position="bottom"))
corrplots = plot_grid(plotlist=lapply(plots, function(x) {
                                                x[["corr"]] +
                                                theme(legend.position="none")}),
                      ncol = 3,
                      labels=c("A", "B", "C")) %>%
  plot_grid(legend_corr, ncol=1, rel_heights = c(1, .2))
# qqplots = plot_grid(plotlist=lapply(plots, function(x) {x[["residue_qq"]]}), ncol = 3, labels=c("D", "E", "F"))
boxplots = plot_grid(plotlist=lapply(plots, function(x) {x[["boxplots"]]})[c(1,3)], ncol = 2, labels=c("D", "E"))
plot_grid(corrplots, boxplots, nrow=2, ncol=1, rel_heights = c(.5, .5))
```
