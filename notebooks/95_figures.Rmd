```{r}
library(dplyr)
library(stringr)
library(readr)
source("config.R")
library(cowplot)
library(boot)
```


# Figures for publication

## Contamination heatmaps

```{r}
load('../results/data_processed.RData')
load('../results/models.RData')

data_corr_array = data_corr 
total_array = data_corr$GSM %>% unique() %>% length()

load('../results/archs4/archs4_data_processed.RData')
load('../results/archs4/archs4_models.RData')

data_corr_ngs = data_corr 
total_ngs = data_corr$GSM %>% unique() %>% length()

```

same as in the section before, but all bioqc signatures aggregated by tissue groups.
```{r}
bioqc_tissue_set = read_csv("../data/bioqc_geo_oracle_dump/BIOQC_TISSUE_SET_DATA_TABLE.csv") %>%
  filter(TISSUE_SET == 'bioqc_all') %>%
  select(SIG_ID=SIGNATURE, DETECTED_TGROUP=TGROUP)
bioqc_all = selected_signatures %>%
  filter(str_detect(SIGNATURE, 'BIOQC')) %>%
  pull("SIGNATURE")

contam_ngs_tgroup = data_corr_ngs %>%
  inner_join(bioqc_signatures, by=c("SIGNATURE"="SIG_NAME")) %>%
  rename(SIG_ID=ID) %>%
  inner_join(bioqc_tissue_set) %>%
  mutate(is_contaminated=qvalue < TAU & q_corr < TAU & TGROUP != DETECTED_TGROUP) %>% 
  mutate(dataset = "ARCHS4")

contam_array_tgroup = data_corr_array %>%
  inner_join(bioqc_signatures, by=c("SIGNATURE"="SIG_NAME")) %>%
  rename(SIG_ID=ID) %>%
  inner_join(bioqc_tissue_set) %>%
  mutate(is_contaminated=qvalue < TAU & q_corr < TAU & TGROUP != DETECTED_TGROUP) %>% 
  mutate(dataset = "GEO")

contam_all = bind_rows(contam_ngs_tgroup, contam_array_tgroup)
```

```{r, fig.width=10, fig.height=5}
tgroups = bioqc_tissue_set$DETECTED_TGROUP %>% unique()
contam_all %>%
  filter(is_contaminated == TRUE) %>%
  group_by(dataset, TGROUP, DETECTED_TGROUP) %>%
  summarise(cnt=n_distinct(GSM)) %>%
  ggplot(aes(x=factor(DETECTED_TGROUP, levels=tgroups), y=TGROUP)) +
      geom_tile(aes(fill=cnt)) +
      geom_text(aes(label=cnt), size=3) +
      theme_bw() + 
      theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust=.5, size=10)) +
      scale_x_discrete(drop=FALSE) +
      ylab("reference tissue") +
      xlab("detected signature") +
      background_grid() +
      facet_grid(dataset~.) + 
      scale_fill_distiller(palette = "Blues", direction=1)

ggsave("../results/figures/heterogeneity_main_res.pdf")
ggsave("../results/figures/heterogeneity_main_res.png")
```


```{r}
stat_fun = function(df, i) {
  df = df[i, ]
  total = nrow(df)
  contaminated = sum(df$sample_is_contaminated)
  contaminated/total
}

bootstrap = function(df_group) {
  boot_obj = boot(df_group, statistic=stat_fun, R=999)
  ci = boot.ci(boot_obj, conf=0.95, type="basic")
  tibble(fraction=boot_obj$t0, ci_low = ci$basic[1,4], ci_high = ci$basic[1, 5])
}

contam_frac = contam_all %>%
  group_by(dataset, TGROUP, GSM) %>%
  summarise(sample_is_contaminated=any(is_contaminated)) %>% 
  group_by(dataset, TGROUP) %>% 
  do(bootstrap(.))
```

```{r}
contam_frac %>%
  ggplot(aes(y=fraction, x=TGROUP)) + 
    geom_bar(aes(fill=dataset), stat="identity", position = "dodge") + 
    geom_errorbar(aes(ymin=ci_low, ymax=ci_high, fill=dataset), position='dodge') + 
    scale_fill_brewer(palette="Set1") + 
    theme(axis.text.x = element_text(angle = 90, hjust=1, vjust=.5)) + 
    xlab("tissue") + 
    ylab("frac. heterogeneous samples")

ggsave("../results/figures/heterogeneity_fractions.pdf")
ggsave("../results/figures/heterogeneity_fractions.png")

```

