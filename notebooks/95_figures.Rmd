```{r, include=FALSE}
library(stringr)
library(readr)
library(MASS)
source("config.R")
library(cowplot)
library(ggplot2)
library(boot)
library(dplyr)
select = dplyr::select
```

```{r loaddata, include=FALSE}
load('../results/data_processed.RData')
load('../results/models.RData')

data_corr_array = data_corr
total_array = data_corr$GSM %>% unique() %>% length()

load('../results/archs4/archs4_data_processed.RData')
load('../results/archs4/archs4_models.RData')

data_corr_ngs = data_corr
total_ngs = data_corr$GSM %>% unique() %>% length()
```




```{r, include=FALSE}
# Same as in the section before, but all bioqc signatures aggregated by tissue groups.
# Additional, we define samples as being "severely heterogeneous", if the reference signature,
# i.e. the signature that should be present according to the annotation, is not enriched at
# an unadjusted p-value < `r SEVERE_THRES`.

bioqc_tissue_set = read_csv("../data/bioqc_geo_oracle_dump/BIOQC_TISSUE_SET_DATA_TABLE.csv") %>%
  filter(TISSUE_SET == 'bioqc_all') %>%
  select(SIG_ID=SIGNATURE, DETECTED_TGROUP=TGROUP)

bioqc_all = selected_signatures %>%
  filter(str_detect(SIGNATURE, 'BIOQC')) %>%
  pull("SIGNATURE")

contam_ngs_tgroup = data_corr_ngs %>%
  inner_join(bioqc_signatures, by=c("SIGNATURE"="SIG_NAME")) %>%
  rename(SIG_ID=ID) %>%
  inner_join(bioqc_tissue_set) %>%
  mutate(is_contaminated=qvalue < TAU & q_corr < TAU & TGROUP != DETECTED_TGROUP) %>%
  mutate(is_severe=is_contaminated & REF_PVALUE >= SEVERE_THRES) %>%
  mutate(dataset = "ARCHS4")

contam_array_tgroup = data_corr_array %>%
  inner_join(bioqc_signatures, by=c("SIGNATURE"="SIG_NAME")) %>%
  rename(SIG_ID=ID) %>%
  inner_join(bioqc_tissue_set) %>%
  mutate(is_contaminated=qvalue < TAU & q_corr < TAU & TGROUP != DETECTED_TGROUP) %>%
  mutate(is_severe=is_contaminated & REF_PVALUE >= SEVERE_THRES) %>%
  mutate(dataset = "GEO")

contam_all = bind_rows(contam_ngs_tgroup, contam_array_tgroup) %>% ungroup()
```

```{r exportfiles, include=FALSE}
heterogeneity_res = contam_all %>%
  select(dataset, GSM, TGROUP, REF_SIG, DETECTED_TGROUP, SIGNATURE, REF_PVALUE, PVALUE, qvalue, p_corr, q_corr, is_contaminated, is_severe) %>%
  distinct()

heterogeneity_res %>%
  write_tsv("../results/heterogeneity_results.tsv")

heterogeneity_res %>%
  select(dataset, GSM, TGROUP, DETECTED_TGROUP, is_contaminated, is_severe) %>%
  distinct() %>%
  write_tsv("../results/heterogeneity_results_summary.tsv")
```

```{r, fig.width=8, fig.height=5, echo=FALSE, warning=FALSE, message=FALSE, fig.cap="Absolute number of samples per tissue in which certain signature is detected as significantly enriched. "}
tgroups = bioqc_tissue_set$DETECTED_TGROUP %>% unique()
p2 = contam_all %>%
  filter(is_contaminated == TRUE) %>%
  group_by(dataset, TGROUP, DETECTED_TGROUP) %>%
  summarise(cnt=n_distinct(GSM)) %>%
  ggplot(aes(x=factor(DETECTED_TGROUP, levels=tgroups), y=TGROUP)) +
      geom_tile(aes(fill=cnt)) +
      geom_text(aes(label=cnt), size=3) +
      theme_bw() +
      theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust=.5, size=10)) +
      scale_x_discrete(drop=FALSE) +
      ylab("reference tissue") +
      xlab("detected signature") +
      background_grid() +
      facet_grid(dataset~.) +
      scale_fill_distiller(palette = "Blues", direction=1, guide=FALSE)

```


```{r, include=FALSE}
# We use bootstrapping (R package `boot`) to derive confidence intervals.
stat_fun_contam = function(df, i) {
  df = df[i, ]
  total = nrow(df)
  contaminated = sum(df$sample_is_contaminated)
  contaminated/total
}

stat_fun_severe = function(df, i) {
  df = df[i, ]
  total = nrow(df)
  contaminated = sum(df$sample_is_severe)
  contaminated/total
}

bootstrap = function(df_group) {
  boot_obj_contam = boot(df_group, statistic=stat_fun_contam, R=999)
  ci_comtam = boot.ci(boot_obj_contam, conf=0.95, type="basic")
  boot_obj_severe = boot(df_group, statistic=stat_fun_severe, R=999)
  ci_severe = boot.ci(boot_obj_severe, conf=0.95, type="basic")
  tibble(type=c("heterogeneity", "severe heterogeneity"),
         fraction=c(boot_obj_contam$t0, boot_obj_severe$t0),
         ci_low = c(ci_comtam$basic[1,4], ci_severe$basic[1,4]),
         ci_high = c(ci_comtam$basic[1, 5], ci_severe$basic[1,5]))
}

contam_frac = contam_all %>%
  bind_rows(contam_all %>% mutate(TGROUP = "all")) %>%
  group_by(dataset, TGROUP, GSM) %>%
  summarise(sample_is_contaminated=any(is_contaminated), sample_is_severe=any(is_severe)) %>%
  group_by(dataset, TGROUP) %>%
  do(bootstrap(.))
```

```{r, include=FALSE, fig.width=8, fig.height=4.5, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="fraction of heterogeneous samples per tissue. ", out.width="100%"}
p1 = contam_frac %>%
  mutate(percent = fraction * 100) %>% 
  ungroup() %>%
  ggplot(aes(y=fraction, x=TGROUP)) +
    geom_bar(aes(fill=dataset), stat="identity", position = "dodge") +
    geom_errorbar(aes(ymin=if_else(ci_low < 0, 0, ci_low), ymax=ci_high, fill=dataset), position='dodge') +
    ylab("% heterogeneous samples") +
    xlab("") + 
    scale_fill_brewer(palette="Set1") +
    theme_cowplot() + 
    background_grid() +
    theme(axis.text.x = element_text(angle = 90, hjust=1, vjust=.5),
          legend.position = "top") +
    facet_wrap(~type) 

ggsave("../results/figures/heterogeneity_fractions.pdf")
ggsave("../results/figures/heterogeneity_fractions.png")
write_tsv(contam_frac, path = "../results/heterogeneity_fractions.tsv")
```


```{r, include=FALSE}
# Stats

contam_frac_nodataset = contam_all %>%
  bind_rows(contam_all %>% mutate(TGROUP = "all")) %>%
  group_by(TGROUP, GSM) %>%
  summarise(sample_is_contaminated=any(is_contaminated), sample_is_severe=any(is_severe)) %>%
  group_by(TGROUP) %>%
  do(bootstrap(.))

write_tsv(contam_frac, path = "../results/heterogeneity_fractions_nodataset.tsv")
```

```{r, include=FALSE, fig.width=8, fig.height=9, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Main figure for paper. (A) Fractions of heterogeneous samples per tissue. (B) Sample confusion matrix."}
plot_grid(p1, p2, align = "v", nrow=2, rel_heights = c(.5, .6), labels = "AUTO", axis="lr")
ggsave("../results/figures/heterogeneity_main.pdf")
ggsave("../results/figures/heterogeneity_main.png")
```


# References
